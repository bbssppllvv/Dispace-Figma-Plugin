<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Preset Studio - Professional Preset Management</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #0a0e13; --panel: #161b22; --border: #30363d; --text: #f0f6fc; 
      --text-muted: #7d8590; --primary: #238636; --accent: #1f6feb;
      --danger: #da3633; --warn: #fb8500; --surface: #21262d;
    }
    
    body {
      font: 14px/1.4 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text); height: 100vh; overflow: hidden;
    }
    
    .studio {
      display: grid; height: 100vh;
      grid-template-columns: 300px 1fr 400px;
      grid-template-rows: 50px 1fr;
      grid-template-areas: "header header header" "sidebar main preview";
    }
    
    .header {
      grid-area: header; background: var(--panel); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 20px; gap: 20px;
    }
    
    .header h1 { font-size: 16px; font-weight: 600; }
    .header .status { 
      margin-left: auto; padding: 4px 12px; border-radius: 12px; 
      background: var(--primary); color: white; font-size: 12px;
    }
    
    .sidebar {
      grid-area: sidebar; background: var(--panel); border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
    }
    
    .main {
      grid-area: main; background: var(--bg); display: flex; flex-direction: column;
      padding: 20px;
    }
    
    .preview {
      grid-area: preview; background: var(--panel); border-left: 1px solid var(--border);
      display: flex; flex-direction: column;
    }
    
    .preset-list {
      flex: 1; overflow-y: auto; padding: 12px;
    }
    
    .category-group {
      margin-bottom: 20px;
    }
    
    .category-header {
      font-size: 12px; color: var(--text-muted); text-transform: uppercase;
      font-weight: 600; margin-bottom: 8px; padding: 0 8px;
    }
    
    .preset-item {
      padding: 12px; margin: 2px 0; border-radius: 8px; cursor: pointer;
      border: 1px solid transparent; transition: all 0.15s;
    }
    
    .preset-item:hover { background: var(--surface); border-color: var(--border); }
    .preset-item.active { background: var(--accent); color: white; }
    
    .preset-name { font-weight: 500; }
    .preset-meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .preset-item.active .preset-meta { color: rgba(255,255,255,0.8); }
    
    .editor {
      flex: 1; display: none;
    }
    
    .editor.active { display: flex; flex-direction: column; }
    
    .editor-header {
      padding: 0 0 20px 0; border-bottom: 1px solid var(--border); margin-bottom: 20px;
    }
    
    .editor-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; }
    
    .form-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;
    }
    
    .form-group {
      display: flex; flex-direction: column; gap: 6px;
    }
    
    .form-label {
      font-size: 12px; color: var(--text-muted); font-weight: 500;
    }
    
    .form-input, .form-select {
      padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border);
      background: var(--surface); color: var(--text); font-size: 14px;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(31, 111, 235, 0.2);
    }
    
    .layers-section {
      flex: 1; display: flex; flex-direction: column;
    }
    
    .section-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;
    }
    
    .section-title { font-size: 14px; font-weight: 600; }
    
    .btn {
      padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border);
      background: var(--surface); color: var(--text); cursor: pointer; font-size: 12px;
      transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px;
    }
    
    .btn:hover { background: var(--border); }
    .btn.primary { background: var(--primary); border-color: var(--primary); color: white; }
    .btn.primary:hover { background: #2ea043; }
    .btn.accent { background: var(--accent); border-color: var(--accent); color: white; }
    
    .layers-list {
      flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
    }
    
    .layer-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
      padding: 16px; display: flex; flex-direction: column; gap: 12px;
    }
    
    .layer-header {
      display: flex; align-items: center; justify-content: space-between;
    }
    
    .layer-title { font-weight: 500; }
    
    .layer-controls {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;
    }
    
    .asset-picker {
      grid-column: span 3; margin-top: 8px; padding: 12px; 
      background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
      display: none;
    }
    
    .asset-picker.active { display: block; }
    
    .asset-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px;
      max-height: 200px; overflow-y: auto;
    }
    
    .asset-item {
      aspect-ratio: 1; border: 1px solid var(--border); border-radius: 4px;
      background: var(--surface); cursor: pointer; overflow: hidden;
      position: relative; transition: all 0.15s;
    }
    
    .asset-item:hover { border-color: var(--accent); }
    .asset-item.selected { border-color: var(--primary); border-width: 2px; }
    
    .asset-item img { width: 100%; height: 100%; object-fit: cover; }
    
    .asset-badge {
      position: absolute; top: 2px; right: 2px; background: var(--primary);
      color: white; font-size: 8px; padding: 2px 4px; border-radius: 2px;
    }
    
    .preview-panel {
      display: flex; flex-direction: column; height: 100%;
    }
    
    .preview-header {
      padding: 16px; border-bottom: 1px solid var(--border);
    }
    
    .preview-container {
      flex: 1; padding: 16px; display: flex; flex-direction: column;
    }
    
    .preview-viewport {
      flex: 1; background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; position: relative; overflow: hidden; min-height: 300px;
    }
    
    .preview-controls {
      padding: 16px 0; display: flex; flex-direction: column; gap: 12px;
    }
    
    .control-group {
      display: flex; flex-direction: column; gap: 6px;
    }
    
    .control-row {
      display: flex; align-items: center; gap: 8px;
    }
    
    .control-label {
      font-size: 11px; color: var(--text-muted); min-width: 60px;
    }
    
    .control-slider {
      flex: 1; height: 4px; border-radius: 2px; background: var(--border);
      appearance: none; cursor: pointer;
    }
    
    .control-slider::-webkit-slider-thumb {
      appearance: none; width: 16px; height: 16px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
    }
    
    .control-value {
      font-size: 11px; color: var(--text-muted); min-width: 40px; text-align: right;
    }
    
    .empty-state {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      justify-content: center; color: var(--text-muted); text-align: center;
    }
    
    .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    
    .toolbar {
      padding: 16px; border-top: 1px solid var(--border); display: flex; gap: 12px;
    }
    
    .status-indicator {
      padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;
    }
    .status-indicator.success { background: var(--primary); color: white; }
    .status-indicator.loading { background: var(--warn); color: white; }
  </style>
</head>
<body>
  <div class="studio">
    <!-- Header -->
    <div class="header">
      <h1>Preset Studio</h1>
      <div class="status-indicator success" id="assetStatus">CDN Ready</div>
      <div class="status" id="presetCount">0 presets</div>
    </div>

    <!-- Sidebar: Preset Library -->
    <div class="sidebar">
      <div style="padding: 16px; border-bottom: 1px solid var(--border);">
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
          <input type="text" id="searchPresets" placeholder="Search presets..." 
                 style="flex: 1; padding: 6px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-size: 12px;">
          <button class="btn primary" id="newPreset">+ New</button>
        </div>
        <select id="categoryFilter" style="width: 100%; padding: 6px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-size: 12px;">
          <option value="">All Categories</option>
        </select>
      </div>
      
      <div class="preset-list" id="presetList">
        <div class="empty-state">
          <div class="empty-icon">📋</div>
          <div>Loading presets...</div>
        </div>
      </div>
    </div>

    <!-- Main: Preset Editor -->
    <div class="main">
      <!-- Empty State -->
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">🎨</div>
        <div style="font-size: 16px; margin-bottom: 8px;">Select or create a preset</div>
        <div style="font-size: 12px;">Choose from the library or create a new preset to get started</div>
      </div>

      <!-- Preset Editor -->
      <div class="editor" id="presetEditor">
        <div class="editor-header">
          <div class="editor-title" id="editorTitle">Preset Name</div>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Preset ID</label>
              <input type="text" class="form-input" id="presetId" placeholder="my-awesome-effect">
            </div>
            <div class="form-group">
              <label class="form-label">Display Name</label>
              <input type="text" class="form-input" id="presetName" placeholder="My Awesome Effect">
            </div>
            <div class="form-group">
              <label class="form-label">Category</label>
              <input type="text" class="form-input" id="presetCategory" placeholder="Custom" list="categoryList">
              <datalist id="categoryList">
                <option value="Ribbed glass">
                <option value="Fabric">
                <option value="Geometric">
                <option value="Organic">
                <option value="Custom">
              </datalist>
            </div>
            <div class="form-group">
              <label class="form-label">Premium</label>
              <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                <input type="checkbox" id="premiumPreset">
                <span style="font-size: 12px;">Requires Pro subscription</span>
              </label>
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Default Scale (%)</label>
              <input type="number" class="form-input" id="defaultScale" min="2" max="400" value="32">
            </div>
            <div class="form-group">
              <label class="form-label">Default Strength</label>
              <input type="number" class="form-input" id="defaultStrength" min="0" max="200" value="133">
            </div>
          </div>
        </div>

        <div class="layers-section">
          <div class="section-header">
            <div class="section-title">Displacement Layers</div>
            <button class="btn primary" id="addLayer">+ Add Layer</button>
          </div>
          
          <div class="layers-list" id="layersList">
            <div class="empty-state">
              <div class="empty-icon">📐</div>
              <div>No layers yet</div>
              <div style="font-size: 12px;">Add a layer to start building your effect</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview Panel -->
    <div class="preview">
      <div class="preview-header">
        <h3 style="font-size: 14px; font-weight: 600;">Live Preview</h3>
        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
          Real-time displacement rendering
        </div>
      </div>
      
      <div class="preview-container">
        <div class="preview-viewport" id="previewViewport">
          <!-- ТОЧНАЯ КОПИЯ SVG фильтра из плагина -->
          <svg id="previewSvg" viewBox="0 0 400 300" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" 
               style="image-rendering: pixelated; image-rendering: crisp-edges;">
            <defs>
              <!-- Mask to hide mirrored edges -->
              <mask id="imageMask">
                <rect id="maskRect" x="0" y="0" width="400" height="300" fill="white"/>
              </mask>
              
              <filter id="f" x="-80" y="-60" width="560" height="420" 
                      color-interpolation-filters="sRGB" filterUnits="userSpaceOnUse" primitiveUnits="userSpaceOnUse">
                
                <!-- Source image, loaded via JS -->
                <feImage id="feSourceImg" width="400" height="300" x="0" y="0" href="/sample01.png" image-rendering="pixelated" result="sourceImage" />
                
                <!-- Displacement map, loaded via JS, which will be tiled -->
                <feImage id="feImg" x="0" y="0" width="400" height="300" result="fileMap" image-rendering="pixelated" />

                <!-- Soft blur applied to displacement map -->
                <feGaussianBlur id="feMapGaussianBlur" in="fileMap" stdDeviation="0" result="fileMapSoft" />
                
                <!-- Pre-blur the source image -->
                <feGaussianBlur id="feSourceGaussianBlur" in="sourceImage" stdDeviation="0" result="BlurredSource" />

                <!-- STEP 1: Separate blurred image into R, G, B channels -->
                <feComponentTransfer in="BlurredSource" result="R_channel">
                  <feFuncG type="table" tableValues="0 0"/>
                  <feFuncB type="table" tableValues="0 0"/>
                </feComponentTransfer>
                <feComponentTransfer in="BlurredSource" result="G_channel">
                  <feFuncR type="table" tableValues="0 0"/>
                  <feFuncB type="table" tableValues="0 0"/>
                </feComponentTransfer>
                <feComponentTransfer in="BlurredSource" result="B_channel">
                  <feFuncR type="table" tableValues="0 0"/>
                  <feFuncG type="table" tableValues="0 0"/>
                </feComponentTransfer>

                <!-- STEP 2: Displace each channel independently based on blurred fileMap -->
                <feDisplacementMap id="feDispMapR" in="R_channel" in2="fileMapSoft" scale="0" xChannelSelector="R" yChannelSelector="G" result="displaced_R" />
                <feDisplacementMap id="feDispMapG" in="G_channel" in2="fileMapSoft" scale="0" xChannelSelector="R" yChannelSelector="G" result="displaced_G" />
                <feDisplacementMap id="feDispMapB" in="B_channel" in2="fileMapSoft" scale="0" xChannelSelector="R" yChannelSelector="G" result="displaced_B" />

                <!-- STEP 3: Recombine the displaced channels -->
                <feBlend in="displaced_R" in2="displaced_G" mode="screen" result="RG_displaced" />
                <feBlend in="RG_displaced" in2="displaced_B" mode="screen" result="FinalDisplaced" />

                <!-- STEP 4: Pass-through to preserve result -->
                <feOffset in="FinalDisplaced" dx="0" dy="0" result="clippedResult" />

                <feMerge>
                  <feMergeNode in="clippedResult"/>
                </feMerge>
              </filter>
            </defs>
            <rect id="outputRect" x="0" y="0" width="400" height="300" filter="url(#f)" mask="url(#imageMask)"/>
          </svg>
        </div>
        
        <div class="preview-controls">
          <div class="control-group">
            <div class="control-row">
              <span class="control-label">Strength</span>
              <input type="range" class="control-slider" id="previewStrength" min="0" max="200" value="133">
              <span class="control-value" id="strengthValue">133</span>
            </div>
            <div class="control-row">
              <span class="control-label">Scale</span>
              <input type="range" class="control-slider" id="previewScale" min="2" max="100" value="32">
              <span class="control-value" id="scaleValue">32%</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="toolbar">
        <button class="btn accent" id="savePreset">💾 Save Preset</button>
        <button class="btn" id="exportCode">📋 Copy JSON</button>
      </div>
    </div>
  </div>

  <!-- Asset Picker Modal (Hidden by default) -->
  <div id="assetModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); border-radius: 12px; padding: 24px; width: 80%; max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h3>Select Displacement Map</h3>
        <button class="btn" id="closeAssetModal">✕</button>
      </div>
      
      <div style="margin-bottom: 16px;">
        <input type="text" id="assetSearch" placeholder="Search assets..." style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--surface); color: var(--text);">
      </div>
      
      <div class="asset-grid" id="assetGrid" style="flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; padding: 8px;">
        <!-- Assets loaded here -->
      </div>
    </div>
  </div>

  <script>
    class PresetStudio {
      constructor() {
        this.presets = new Map();
        this.assets = new Map();
        this.currentPreset = null;
        this.cdnUrl = 'https://dispace-figma-assets.vercel.app';
        this.proxyUrl = '/api/cdn'; // Local proxy to avoid CORS
        
        this.initializeElements();
        this.setupEventListeners();
        this.loadAssets();
        this.loadPresets();
      }

      initializeElements() {
        this.elements = {
          presetList: document.getElementById('presetList'),
          emptyState: document.getElementById('emptyState'),
          presetEditor: document.getElementById('presetEditor'),
          editorTitle: document.getElementById('editorTitle'),
          presetId: document.getElementById('presetId'),
          presetName: document.getElementById('presetName'),
          presetCategory: document.getElementById('presetCategory'),
          premiumPreset: document.getElementById('premiumPreset'),
          defaultScale: document.getElementById('defaultScale'),
          defaultStrength: document.getElementById('defaultStrength'),
          layersList: document.getElementById('layersList'),
          assetStatus: document.getElementById('assetStatus'),
          presetCount: document.getElementById('presetCount'),
          assetModal: document.getElementById('assetModal'),
          assetGrid: document.getElementById('assetGrid'),
          previewStrength: document.getElementById('previewStrength'),
          previewScale: document.getElementById('previewScale'),
          strengthValue: document.getElementById('strengthValue'),
          scaleValue: document.getElementById('scaleValue'),
          // SVG filter elements (точная копия из плагина)
          feImg: document.getElementById('feImg'),
          feSourceImg: document.getElementById('feSourceImg'),
          feDispMapR: document.getElementById('feDispMapR'),
          feDispMapG: document.getElementById('feDispMapG'),
          feDispMapB: document.getElementById('feDispMapB'),
          feMapGaussianBlur: document.getElementById('feMapGaussianBlur'),
          feSourceGaussianBlur: document.getElementById('feSourceGaussianBlur')
        };
      }

      setupEventListeners() {
        document.getElementById('newPreset').addEventListener('click', () => this.createNewPreset());
        document.getElementById('addLayer').addEventListener('click', () => this.addLayer());
        document.getElementById('savePreset').addEventListener('click', () => this.savePreset());
        document.getElementById('exportCode').addEventListener('click', () => this.exportCode());
        document.getElementById('closeAssetModal').addEventListener('click', () => this.closeAssetModal());

        // Preview controls (только Strength и Scale)
        this.elements.previewStrength.addEventListener('input', () => this.updatePreview());
        this.elements.previewScale.addEventListener('input', () => this.updatePreview());

        // Update value displays
        this.elements.previewStrength.addEventListener('input', (e) => {
          this.elements.strengthValue.textContent = e.target.value;
        });
        this.elements.previewScale.addEventListener('input', (e) => {
          this.elements.scaleValue.textContent = e.target.value + '%';
        });

        // Form changes
        ['presetId', 'presetName', 'presetCategory', 'defaultScale', 'defaultStrength'].forEach(id => {
          document.getElementById(id).addEventListener('input', () => this.updateCurrentPreset());
        });
        document.getElementById('premiumPreset').addEventListener('change', () => this.updateCurrentPreset());
      }

      async loadAssets() {
        this.elements.assetStatus.textContent = 'Loading...';
        this.elements.assetStatus.className = 'status-indicator loading';
        
        try {
          // Auto-scan GitHub for all SVG files
          const response = await fetch('https://api.github.com/repos/bbssppllvv/Dispace-Figma-Plugin/contents/assets/displacement-maps/svg');
          
          if (response.ok) {
            const files = await response.json();
            this.assets.clear();
            
            for (const file of files) {
              if (file.type === 'file' && file.name.endsWith('.svg')) {
                const id = file.name.replace(/\.[^/.]+$/, '');
                this.assets.set(id, {
                  id,
                  name: file.name,
                  type: 'svg',
                  size: file.size,
                  url: `https://raw.githubusercontent.com/bbssppllvv/Dispace-Figma-Plugin/main/assets/displacement-maps/svg/${file.name}`,
                  hash: file.sha
                });
              }
            }
            
            this.elements.assetStatus.textContent = `${this.assets.size} assets`;
            this.elements.assetStatus.className = 'status-indicator success';
            
            console.log(`✅ Loaded ${this.assets.size} assets from CDN`);
          }
        } catch (error) {
          console.error('Failed to load assets:', error);
          this.elements.assetStatus.textContent = 'Load failed';
          this.elements.assetStatus.className = 'status-indicator';
        }
      }

      async loadPresets() {
        try {
          // Временно используем GitHub raw files вместо CDN
          const githubUrl = 'https://raw.githubusercontent.com/bbssppllvv/Dispace-Figma-Plugin/main/assets/presets.json';
          const response = await fetch(githubUrl, { cache: 'no-cache' });
          
          if (response.ok) {
            const data = await response.json();
            this.presets.clear();
            
            (data.presets || []).forEach(preset => {
              this.presets.set(preset.id, preset);
            });
            
            this.renderPresetList();
            this.elements.presetCount.textContent = `${this.presets.size} presets`;
            
            console.log(`✅ Loaded ${this.presets.size} presets from CDN`);
          }
        } catch (error) {
          console.error('Failed to load presets:', error);
        }
      }

      renderPresetList() {
        const categories = new Map();
        
        // Group by category
        this.presets.forEach(preset => {
          const cat = preset.category || 'Uncategorized';
          if (!categories.has(cat)) categories.set(cat, []);
          categories.get(cat).push(preset);
        });

        // Render
        this.elements.presetList.innerHTML = '';
        
        if (categories.size === 0) {
          this.elements.presetList.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">📋</div>
              <div>No presets found</div>
            </div>
          `;
          return;
        }

        categories.forEach((presets, category) => {
          const group = document.createElement('div');
          group.className = 'category-group';
          
          const header = document.createElement('div');
          header.className = 'category-header';
          header.textContent = category;
          group.appendChild(header);

          presets.forEach(preset => {
            const item = document.createElement('div');
            item.className = 'preset-item';
            item.innerHTML = `
              <div class="preset-name">${preset.name} ${preset.premium ? '👑' : ''}</div>
              <div class="preset-meta">${preset.layers?.length || 0} layers • Scale: ${preset.defaultScale}%</div>
            `;
            
            item.addEventListener('click', () => this.selectPreset(preset.id));
            group.appendChild(item);
          });

          this.elements.presetList.appendChild(group);
        });
      }

      selectPreset(presetId) {
        // Remove active state from all items
        document.querySelectorAll('.preset-item').forEach(item => {
          item.classList.remove('active');
        });
        
        // Add active state to selected item
        event.target.closest('.preset-item').classList.add('active');
        
        const preset = this.presets.get(presetId);
        if (!preset) return;

        this.currentPreset = preset;
        this.loadPresetIntoEditor(preset);
        this.showEditor();
      }

      loadPresetIntoEditor(preset) {
        this.elements.editorTitle.textContent = preset.name;
        this.elements.presetId.value = preset.id;
        this.elements.presetName.value = preset.name;
        this.elements.presetCategory.value = preset.category || '';
        this.elements.premiumPreset.checked = preset.premium || false;
        this.elements.defaultScale.value = preset.defaultScale || 32;
        this.elements.defaultStrength.value = preset.defaultStrength || 133;

        // Update preview controls
        this.elements.previewScale.value = preset.defaultScale || 32;
        this.elements.previewStrength.value = preset.defaultStrength || 133;
        this.elements.scaleValue.textContent = (preset.defaultScale || 32) + '%';
        this.elements.strengthValue.textContent = preset.defaultStrength || 133;

        this.renderLayers(preset.layers || []);
        this.updatePreview();
      }

      renderLayers(layers) {
        this.elements.layersList.innerHTML = '';
        
        if (layers.length === 0) {
          this.elements.layersList.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">📐</div>
              <div>No layers yet</div>
              <div style="font-size: 12px;">Add a layer to start building your effect</div>
            </div>
          `;
          return;
        }

        layers.forEach((layer, index) => {
          this.createLayerCard(layer, index);
        });
      }

      createLayerCard(layer, index) {
        const card = document.createElement('div');
        card.className = 'layer-card';
        card.innerHTML = `
          <div class="layer-header">
            <div class="layer-title">Layer ${index + 1}</div>
            <button class="btn" onclick="studio.removeLayer(${index})">Remove</button>
          </div>
          
          <div style="margin-bottom: 12px;">
            <div class="form-label">Displacement Map</div>
            <button class="btn" onclick="studio.selectAssetForLayer(${index})" style="width: 100%; justify-content: center;">
              ${layer.src ? this.getAssetName(layer.src) : 'Choose Asset...'}
            </button>
          </div>

          <div class="layer-controls">
            <div class="form-group">
              <label class="form-label">Tiling</label>
              <select class="form-select" data-layer-prop="tiling" onchange="studio.updateLayer(${index}, 'tiling', this.value)">
                <option value="tiled" ${layer.tiling === 'tiled' ? 'selected' : ''}>Tiled</option>
                <option value="stretched" ${layer.tiling === 'stretched' ? 'selected' : ''}>Stretched</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Scale Mode</label>
              <select class="form-select" data-layer-prop="scaleMode" onchange="studio.updateLayer(${index}, 'scaleMode', this.value)">
                <option value="uniform" ${layer.scaleMode === 'uniform' ? 'selected' : ''}>Uniform</option>
                <option value="xOnly" ${layer.scaleMode === 'xOnly' ? 'selected' : ''}>X Only</option>
                <option value="yOnly" ${layer.scaleMode === 'yOnly' ? 'selected' : ''}>Y Only</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Blend Mode</label>
              <select class="form-select" data-layer-prop="blendMode" onchange="studio.updateLayer(${index}, 'blendMode', this.value)">
                <option value="" ${!layer.blendMode ? 'selected' : ''}>Normal</option>
                <option value="overlay" ${layer.blendMode === 'overlay' ? 'selected' : ''}>Overlay</option>
                <option value="multiply" ${layer.blendMode === 'multiply' ? 'selected' : ''}>Multiply</option>
                <option value="screen" ${layer.blendMode === 'screen' ? 'selected' : ''}>Screen</option>
              </select>
            </div>
          </div>
        `;

        this.elements.layersList.appendChild(card);
      }

      getAssetName(src) {
        if (src.startsWith('resource://')) {
          const id = src.replace('resource://', '');
          const asset = this.assets.get(id);
          return asset ? asset.name : id;
        }
        return src.split('/').pop() || 'Unknown';
      }

      showEditor() {
        this.elements.emptyState.style.display = 'none';
        this.elements.presetEditor.classList.add('active');
      }

      createNewPreset() {
        const id = `preset-${Date.now()}`;
        const newPreset = {
          id,
          name: 'New Preset',
          category: 'Custom',
          defaultScale: 32,
          defaultStrength: 133,
          layers: []
        };

        this.presets.set(id, newPreset);
        this.currentPreset = newPreset;
        this.renderPresetList();
        this.loadPresetIntoEditor(newPreset);
        this.showEditor();
      }

      addLayer() {
        if (!this.currentPreset) return;
        
        if (!this.currentPreset.layers) this.currentPreset.layers = [];
        
        this.currentPreset.layers.push({
          src: '',
          tiling: 'tiled',
          scaleMode: 'uniform'
        });

        this.renderLayers(this.currentPreset.layers);
      }

      removeLayer(index) {
        if (!this.currentPreset || !this.currentPreset.layers) return;
        
        this.currentPreset.layers.splice(index, 1);
        this.renderLayers(this.currentPreset.layers);
        this.updatePreview();
      }

      selectAssetForLayer(layerIndex) {
        this.currentLayerIndex = layerIndex;
        this.showAssetModal();
      }

      showAssetModal() {
        this.renderAssetGrid();
        this.elements.assetModal.style.display = 'block';
      }

      closeAssetModal() {
        this.elements.assetModal.style.display = 'none';
      }

      renderAssetGrid() {
        this.elements.assetGrid.innerHTML = '';

        this.assets.forEach(asset => {
          const item = document.createElement('div');
          item.className = 'asset-item';
          item.innerHTML = `
            <img src="${asset.url}" alt="${asset.name}" loading="lazy">
            <div class="asset-badge">CDN</div>
          `;
          
          item.addEventListener('click', () => this.selectAsset(asset.id));
          this.elements.assetGrid.appendChild(item);
        });
      }

      selectAsset(assetId) {
        if (!this.currentPreset || !this.currentPreset.layers || this.currentLayerIndex === undefined) return;
        
        this.currentPreset.layers[this.currentLayerIndex].src = `resource://${assetId}`;
        this.renderLayers(this.currentPreset.layers);
        this.updatePreview();
        this.closeAssetModal();
      }

      updateLayer(index, prop, value) {
        if (!this.currentPreset || !this.currentPreset.layers) return;
        
        this.currentPreset.layers[index][prop] = value;
        this.updatePreview();
      }

      updateCurrentPreset() {
        if (!this.currentPreset) return;

        this.currentPreset.id = this.elements.presetId.value;
        this.currentPreset.name = this.elements.presetName.value;
        this.currentPreset.category = this.elements.presetCategory.value;
        this.currentPreset.defaultScale = parseInt(this.elements.defaultScale.value);
        this.currentPreset.defaultStrength = parseInt(this.elements.defaultStrength.value);
        this.currentPreset.premium = this.elements.premiumPreset.checked;

        this.elements.editorTitle.textContent = this.currentPreset.name;
        this.renderPresetList();
      }

      async updatePreview() {
        console.log('🎨 Updating preview (CANVAS GENERATION like plugin)...');
        
        // Только базовые настройки
        const strength = parseInt(this.elements.previewStrength.value) || 0;
        const scale = parseInt(this.elements.previewScale.value) || 32;
        
        console.log(`Settings: strength=${strength}, scale=${scale}`);

        if (!this.currentPreset || !this.currentPreset.layers || this.currentPreset.layers.length === 0) {
          console.log('No preset or layers, clearing displacement map');
          if (this.elements.feImg) {
            this.elements.feImg.setAttribute('href', '');
          }
          this.resetDisplacementScales();
          return;
        }

        // КЛЮЧЕВОЕ ОТЛИЧИЕ: Генерируем displacement texture через Canvas (как в плагине)
        try {
          await this.generateDisplacementTexture(scale);
        } catch (error) {
          console.error('Failed to generate displacement texture:', error);
          return;
        }

        // Убираем blur эффекты (не нужны для базового preview)
        if (this.elements.feSourceGaussianBlur) {
          this.elements.feSourceGaussianBlur.setAttribute('stdDeviation', '0');
        }
        if (this.elements.feMapGaussianBlur) {
          this.elements.feMapGaussianBlur.setAttribute('stdDeviation', '0');
        }

        // Применяем одинаковый displacement ко всем каналам (без chromatic)
        const displacementScale = strength;

        if (this.elements.feDispMapR) {
          this.elements.feDispMapR.setAttribute('scale', displacementScale.toString());
        }
        if (this.elements.feDispMapG) {
          this.elements.feDispMapG.setAttribute('scale', displacementScale.toString());
        }
        if (this.elements.feDispMapB) {
          this.elements.feDispMapB.setAttribute('scale', displacementScale.toString());
        }

        console.log(`✅ Applied displacement: ${displacementScale} (with Canvas-generated texture)`);
      }

      async generateDisplacementTexture(scalePct) {
        console.log('🗺️ Generating Canvas displacement texture (like in plugin)...');
        
        const canvas = document.createElement('canvas');
        canvas.width = 400;
        canvas.height = 300;
        const ctx = canvas.getContext('2d');
        
        // Clear canvas
        ctx.clearRect(0, 0, 400, 300);
        
        // Используем локальные SVG файлы для избежания CORS
        const layers = this.currentPreset.layers || [];
        
        for (const layer of layers) {
          if (!layer.src || !layer.src.startsWith('resource://')) continue;
          
          const assetId = layer.src.replace('resource://', '');
          
          // Создаем простую тестовую текстуру для каждого типа
          let testTexture;
          if (assetId.includes('horizontal')) {
            testTexture = this.createHorizontalGradient();
          } else if (assetId.includes('vertical')) {
            testTexture = this.createVerticalGradient();
          } else {
            testTexture = this.createRadialGradient();
          }
          
          // Рисуем tiled текстуру
          await this.drawTiledTexture(ctx, 400, 300, testTexture, scalePct, layer);
          
          console.log(`✅ Drew layer: ${assetId} (generated texture)`);
        }
        
        // Если нет слоев, создаем нейтральную текстуру
        if (layers.length === 0) {
          ctx.fillStyle = '#808080';
          ctx.fillRect(0, 0, 400, 300);
        }
        
        // Применяем к SVG фильтру
        const dataUrl = canvas.toDataURL('image/png');
        if (this.elements.feImg) {
          this.elements.feImg.setAttribute('href', dataUrl);
          console.log('✅ Updated feImg with Canvas-generated displacement texture');
        }
      }

      createHorizontalGradient() {
        const canvas = document.createElement('canvas');
        canvas.width = 100;
        canvas.height = 50;
        const ctx = canvas.getContext('2d');
        
        const gradient = ctx.createLinearGradient(0, 0, 100, 0);
        gradient.addColorStop(0, '#000000');    // Black = left displacement
        gradient.addColorStop(0.5, '#808080');  // Gray = no displacement  
        gradient.addColorStop(1, '#ffffff');    // White = right displacement
        
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 100, 50);
        
        return canvas;
      }

      createVerticalGradient() {
        const canvas = document.createElement('canvas');
        canvas.width = 50;
        canvas.height = 100;
        const ctx = canvas.getContext('2d');
        
        const gradient = ctx.createLinearGradient(0, 0, 0, 100);
        gradient.addColorStop(0, '#000000');    // Black = up displacement
        gradient.addColorStop(0.5, '#808080');  // Gray = no displacement
        gradient.addColorStop(1, '#ffffff');    // White = down displacement
        
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 50, 100);
        
        return canvas;
      }

      createRadialGradient() {
        const canvas = document.createElement('canvas');
        canvas.width = 200;
        canvas.height = 200;
        const ctx = canvas.getContext('2d');
        
        const gradient = ctx.createRadialGradient(100, 100, 0, 100, 100, 100);
        gradient.addColorStop(0, '#ffffff');    // White = outward displacement
        gradient.addColorStop(0.5, '#808080');  // Gray = no displacement
        gradient.addColorStop(1, '#000000');    // Black = inward displacement
        
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 200, 200);
        
        return canvas;
      }

      async drawTiledTexture(ctx, canvasW, canvasH, textureCanvas, scalePct, layer) {
        const scale = scalePct * 0.01;
        let w = Math.max(1, textureCanvas.width * scale);
        let h = Math.max(1, textureCanvas.height * scale);
        
        const scaleMode = layer.scaleMode || 'uniform';
        if (scaleMode === 'xOnly') h = canvasH;
        else if (scaleMode === 'yOnly') w = canvasW;
        
        // Alignment
        let originX = 0, originY = 0;
        const alignX = layer.alignX || 'center';
        const alignY = layer.alignY || 'center';
        
        if (alignX === 'center') originX = Math.floor((canvasW - w) / 2);
        else if (alignX === 'right') originX = canvasW - w;
        if (alignY === 'center') originY = Math.floor((canvasH - h) / 2);
        else if (alignY === 'bottom') originY = canvasH - h;
        
        // Tiling (как в FilterRenderer)
        const startI = Math.floor((0 - originX) / w) - 1;
        const startJ = Math.floor((0 - originY) / h) - 1;
        const endI = Math.ceil((canvasW - originX) / w) + 1;
        const endJ = Math.ceil((canvasH - originY) / h) + 1;
        
        for (let i = startI; i <= endI; i++) {
          for (let j = startJ; j <= endJ; j++) {
            const x = originX + i * w;
            const y = originY + j * h;
            if (x > canvasW || y > canvasH || x + w < 0 || y + h < 0) continue;
            ctx.drawImage(textureCanvas, x, y, w, h);
          }
        }
      }

      resetDisplacementScales() {
        // Reset все displacement scales к 0
        if (this.elements.feDispMapR) this.elements.feDispMapR.setAttribute('scale', '0');
        if (this.elements.feDispMapG) this.elements.feDispMapG.setAttribute('scale', '0');
        if (this.elements.feDispMapB) this.elements.feDispMapB.setAttribute('scale', '0');
      }





      savePreset() {
        if (!this.currentPreset) return;

        // Update preset in memory
        this.presets.set(this.currentPreset.id, { ...this.currentPreset });

        // Generate complete presets.json
        const manifest = {
          version: '1.0.0',
          updated: new Date().toISOString(),
          presets: Array.from(this.presets.values()).sort((a, b) => {
            const categoryOrder = { 'Popular': 1, 'Ribbed glass': 2, 'Fabric': 3, 'Geometric': 4, 'Organic': 5, 'Custom': 100 };
            const pa = categoryOrder[a.category] || 999;
            const pb = categoryOrder[b.category] || 999;
            if (pa !== pb) return pa - pb;
            return a.name.localeCompare(b.name);
          })
        };

        const output = JSON.stringify(manifest, null, 2);
        
        // Auto-copy to clipboard
        navigator.clipboard.writeText(output).then(() => {
          alert('✅ Preset saved and copied to clipboard!\n\nRun: npm run preset:save');
        }).catch(() => {
          // Fallback: show in modal
          const textarea = document.createElement('textarea');
          textarea.value = output;
          textarea.style.width = '100%';
          textarea.style.height = '300px';
          textarea.style.fontFamily = 'monospace';
          textarea.style.fontSize = '12px';
          
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:2000';
          modal.innerHTML = `
            <div style="background:var(--panel);padding:24px;border-radius:12px;width:80%;max-height:80vh;overflow:hidden;display:flex;flex-direction:column">
              <h3 style="margin-bottom:16px">Copy this JSON to assets/presets.json:</h3>
              <textarea readonly style="flex:1;margin-bottom:16px;padding:12px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);font-family:monospace;font-size:12px">${output}</textarea>
              <button onclick="this.parentElement.parentElement.remove()" style="padding:8px 16px;border-radius:6px;border:1px solid var(--border);background:var(--primary);color:white;cursor:pointer">Close</button>
            </div>
          `;
          
          document.body.appendChild(modal);
        });

        console.log('💾 Preset saved:', this.currentPreset);
      }

      exportCode() {
        this.savePreset();
      }
    }

    // Initialize
    const studio = new PresetStudio();
  </script>
</body>
</html>
