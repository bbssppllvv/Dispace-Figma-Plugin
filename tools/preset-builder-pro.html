<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preset Builder Pro ‚Äî Professional Asset Management</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151821; --muted:#8a92a6; --text:#e8ecf3; --primary:#6ee7ff;
      --accent:#a78bfa; --ok:#34d399; --warn:#f59e0b; --danger:#ef4444; --border:#222738;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0e1117,#0b0d13 40%,#0e1117);color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1{font-size:20px;margin:0 0 8px 0}
    h2{font-size:16px;margin:16px 0 8px 0}
    .app{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;gap:12px}
    .cols{grid-template-columns:1fr 1fr 300px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;
      box-shadow:0 6px 20px rgba(0,0,0,.25)}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%;padding:9px 10px;border-radius:10px;border:1px solid var(--border);
      background:#0c0f16;color:var(--text);outline:none;transition:.2s border-color,.2s box-shadow;
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .row > .col-3{grid-column:span 3}
    .row > .col-4{grid-column:span 4}
    .row > .col-6{grid-column:span 6}
    .row > .col-12{grid-column:span 12}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:9px 12px;border-radius:10px;
      border:1px solid var(--border);color:var(--text);background:#10131b;cursor:pointer;
      transition:.15s transform,.2s background,.2s border-color;user-select:none}
    .btn:hover{background:#141827}
    .btn.primary{background:linear-gradient(180deg,#1a2a3a,#122233);border-color:#1e293b}
    .btn.ok{background:linear-gradient(180deg,#0f382b,#0d2f24);border-color:#134e4a}
    .asset-item{background:#0f1420;border:1px solid #27304a;border-radius:8px;padding:8px;margin:4px 0;
      display:flex;align-items:center;gap:8px}
    .asset-preview{width:40px;height:40px;border-radius:4px;background:#1a1f2e;
      display:flex;align-items:center;justify-content:center;overflow:hidden}
    .asset-preview img{max-width:100%;max-height:100%;object-fit:contain}
    .asset-info{flex:1}
    .asset-name{font-size:12px;font-weight:500}
    .asset-meta{font-size:11px;color:var(--muted)}
    .upload-zone{border:2px dashed var(--border);border-radius:12px;padding:40px;text-align:center;
      cursor:pointer;transition:.2s border-color}
    .upload-zone:hover{border-color:var(--accent)}
    .upload-zone.dragover{border-color:var(--primary);background:rgba(110,231,255,0.05)}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;background:#0b0e14;border:1px solid var(--border);
      border-radius:12px;padding:12px;min-height:160px;font-size:12px}
    .status{padding:8px 12px;border-radius:8px;margin:8px 0;font-size:12px}
    .status.success{background:#0f382b;border:1px solid #134e4a;color:var(--ok)}
    .status.error{background:#3d1a1a;border:1px solid #5d2a2a;color:var(--danger)}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="app">
    <h1>üöÄ Preset Builder Pro <span style="font-size:12px;color:var(--muted)">Professional Asset Management</span></h1>
    
    <div class="grid cols">
      <!-- LEFT: Preset Library -->
      <div class="card">
        <h2>üìö Preset Library</h2>
        
        <!-- Search and Filter -->
        <div class="inline" style="margin-bottom:12px">
          <input id="searchPresets" type="text" placeholder="Search presets..." style="flex:1;margin-right:8px">
          <select id="filterCategory" style="width:150px">
            <option value="">All Categories</option>
            <option value="Ribbed glass">Ribbed glass</option>
            <option value="Fabric">Fabric</option>
            <option value="Geometric">Geometric</option>
            <option value="Organic">Organic</option>
            <option value="Custom">Custom</option>
          </select>
        </div>

        <!-- Preset List -->
        <div id="presetLibrary" style="max-height:400px;overflow-y:auto">
          <!-- Presets will be loaded here -->
        </div>

        <div class="inline" style="margin-top:12px">
          <button class="btn primary" id="newPreset">+ New Preset</button>
          <button class="btn" id="loadFromRegistry">üîÑ Reload Library</button>
        </div>
      </div>

      <!-- CENTER: Asset Management -->
      <div class="card">
        <h2>üìÅ Asset Management</h2>
        
        <!-- Upload Zone -->
        <div class="upload-zone" id="uploadZone">
          <div style="font-size:24px;margin-bottom:8px">üì§</div>
          <div>Drop SVG/PNG files here or click to browse</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">
            Supports: SVG, PNG ‚Ä¢ Max 2MB per file
          </div>
          <input type="file" id="fileInput" multiple accept=".svg,.png" style="display:none">
        </div>

        <div id="uploadStatus"></div>

        <!-- Asset Library -->
        <h3 style="margin:16px 0 8px 0">üìö Asset Library</h3>
        <div id="assetLibrary">
          <div class="asset-item">
            <div class="asset-preview">üé®</div>
            <div class="asset-info">
              <div class="asset-name">No assets uploaded</div>
              <div class="asset-meta">Upload some SVG/PNG files to get started</div>
            </div>
          </div>
        </div>

        <!-- CDN Configuration -->
        <h3 style="margin:16px 0 8px 0">üåê CDN Configuration</h3>
        <div class="row">
          <div class="col-12">
            <label for="cdnUrl">CDN Base URL</label>
            <input id="cdnUrl" type="text" value="https://dispace-figma-assets.vercel.app" placeholder="https://dispace-figma-assets.vercel.app" />
          </div>
        </div>
        
        <div class="inline" style="margin-top:8px">
          <button class="btn primary" id="uploadToCdn">üöÄ Upload to CDN</button>
          <button class="btn" id="generateManifest">üìã Generate Manifest</button>
        </div>
      </div>

      <!-- RIGHT: Preset Configuration -->
      <div class="card">
        <h2>üéõÔ∏è Preset Configuration</h2>
        
        <div id="presetEditor" style="display:none">
          <!-- Preset editor will be shown when editing -->
        
        <div class="row">
          <div class="col-6">
            <label for="presetId">Preset ID</label>
            <input id="presetId" type="text" placeholder="horizontal-glass" />
          </div>
          <div class="col-6">
            <label for="presetName">Display Name</label>
            <input id="presetName" type="text" placeholder="Horizontal Glass" />
          </div>
          <div class="col-6">
            <label for="category">Category</label>
            <select id="category">
              <option value="Ribbed glass">Ribbed glass</option>
              <option value="Fabric">Fabric</option>
              <option value="Geometric">Geometric</option>
              <option value="Organic">Organic</option>
              <option value="Custom">Custom</option>
            </select>
          </div>
          <div class="col-3">
            <label for="defaultScale">Default Scale (%)</label>
            <input id="defaultScale" type="number" min="2" max="400" value="32" />
          </div>
          <div class="col-3">
            <label for="defaultStrength">Default Strength</label>
            <input id="defaultStrength" type="number" min="0" max="200" value="133" />
          </div>
        </div>

        <!-- Layer Configuration -->
        <h3 style="margin:16px 0 8px 0">üìê Layers</h3>
        <div id="layerConfig">
          <!-- Layers will be added dynamically -->
        </div>
        
        <div class="inline" style="margin-top:8px">
          <button class="btn" id="addLayer">+ Add Layer</button>
          <label style="margin-left:12px">
            <input type="checkbox" id="premiumPreset"> Premium Preset
          </label>
        </div>
      </div>

      <!-- RIGHT: Output & Preview -->
      <div class="card">
        <h2>üì§ Export</h2>
        
        <div class="inline" style="margin-bottom:8px">
          <select id="exportFormat">
            <option value="typescript">TypeScript File</option>
            <option value="json">JSON</option>
            <option value="manifest">Add to Manifest</option>
          </select>
        </div>

        <pre id="output" style="height:300px;overflow-y:auto"></pre>
        
        <div class="inline" style="margin-top:8px">
          <button class="btn ok" id="copyOutput">üìã Copy</button>
          <button class="btn primary" id="saveFile">üíæ Save File</button>
        </div>

        <!-- Live Preview -->
        <h3 style="margin:16px 0 8px 0">üëÅÔ∏è Live Preview</h3>
        <div style="width:100%;height:200px;background:#0b0e14;border-radius:8px;position:relative;overflow:hidden">
          <svg id="previewSvg" viewBox="0 0 400 300" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <filter id="previewFilter" x="-20%" y="-20%" width="140%" height="140%">
                <feImage id="previewMap" href="" result="map"/>
                <feDisplacementMap in="SourceGraphic" in2="map" scale="50" xChannelSelector="R" yChannelSelector="G"/>
              </filter>
            </defs>
            <image x="0" y="0" width="400" height="300" preserveAspectRatio="xMidYMid slice" 
                   filter="url(#previewFilter)" href="../sample01.png"/>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Preset Library Manager
    class PresetLibraryManager {
      constructor() {
        this.presets = new Map();
        this.currentPreset = null;
        this.initEventListeners();
        this.loadPresetLibrary();
      }

      initEventListeners() {
        document.getElementById('searchPresets').addEventListener('input', (e) => {
          this.filterPresets(e.target.value, document.getElementById('filterCategory').value);
        });

        document.getElementById('filterCategory').addEventListener('change', (e) => {
          this.filterPresets(document.getElementById('searchPresets').value, e.target.value);
        });

        document.getElementById('newPreset').addEventListener('click', () => {
          this.createNewPreset();
        });

        document.getElementById('loadFromRegistry').addEventListener('click', () => {
          this.loadPresetLibrary();
        });
      }

      async loadPresetLibrary() {
        try {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –µ–¥–∏–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–µ—Å–µ—Ç–æ–≤ —Å CDN
          const response = await fetch('https://dispace-figma-assets.vercel.app/presets.json', {
            cache: 'no-cache'
          });
          
          if (response.ok) {
            const data = await response.json();
            const presets = data.presets || [];
            
            this.presets.clear();
            presets.forEach(preset => {
              this.presets.set(preset.id, preset);
            });
            
            console.log(`‚úÖ Loaded ${presets.length} presets from CDN`);
          } else {
            console.warn('Could not load presets from CDN, using defaults');
            this.loadDefaultPresets();
          }
        } catch (error) {
          console.warn('Error loading presets:', error);
          this.loadDefaultPresets();
        }

        this.renderPresetLibrary();
      }

      parsePresetsFromTypeScript(content) {
        // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–æ–≤ –∏–∑ TypeScript —Ñ–∞–π–ª–∞
        try {
          // –ò—â–µ–º –º–∞—Å—Å–∏–≤ –ø—Ä–µ—Å–µ—Ç–æ–≤ –≤ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º —Ñ–∞–π–ª–∞
          const match = content.match(/const\s+\w+:\s*Preset\[\]\s*=\s*(\[[\s\S]*?\]);/);
          if (match) {
            // –ó–∞–º–µ–Ω—è–µ–º TypeScript —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –Ω–∞ JSON
            let jsonStr = match[1]
              .replace(/(\w+):/g, '"$1":')  // –∫–ª—é—á–∏ –≤ –∫–∞–≤—ã—á–∫–∏
              .replace(/'/g, '"')           // –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤ –¥–≤–æ–π–Ω—ã–µ
              .replace(/,(\s*[}\]])/g, '$1'); // —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–ø—è—Ç—ã–µ
            
            return JSON.parse(jsonStr);
          }
        } catch (error) {
          console.warn('Could not parse TypeScript presets:', error);
        }
        return [];
      }

      loadDefaultPresets() {
        const defaultPresets = [
          {
            id: 'horizontal-glass',
            name: 'Horizontal Glass',
            category: 'Ribbed glass',
            defaultScale: 32,
            defaultStrength: 133,
            layers: [
              { src: 'resource://horizontal-bands', tiling: 'tiled', scaleMode: 'xOnly' }
            ]
          },
          {
            id: 'vertical-glass',
            name: 'Vertical Glass',
            category: 'Ribbed glass', 
            defaultScale: 39,
            defaultStrength: 133,
            layers: [
              { src: 'resource://vertical-ripple', tiling: 'tiled', scaleMode: 'yOnly' }
            ]
          }
        ];

        this.presets.clear();
        defaultPresets.forEach(preset => {
          this.presets.set(preset.id, preset);
        });
      }

      renderPresetLibrary() {
        const library = document.getElementById('presetLibrary');
        library.innerHTML = '';

        if (this.presets.size === 0) {
          library.innerHTML = `
            <div class="asset-item">
              <div class="asset-preview">üìã</div>
              <div class="asset-info">
                <div class="asset-name">No presets found</div>
                <div class="asset-meta">Create your first preset</div>
              </div>
            </div>
          `;
          return;
        }

        this.presets.forEach((preset) => {
          const item = document.createElement('div');
          item.className = 'asset-item';
          item.style.cursor = 'pointer';
          
          const layerCount = preset.layers ? preset.layers.length : 0;
          const isPremium = preset.premium ? 'üëë' : '';
          
          item.innerHTML = `
            <div class="asset-preview" style="background: linear-gradient(45deg, #1a1f2e, #2a2f3e)">
              <div style="font-size:18px">${isPremium || 'üé®'}</div>
            </div>
            <div class="asset-info">
              <div class="asset-name">${preset.name} ${isPremium}</div>
              <div class="asset-meta">${preset.category} ‚Ä¢ ${layerCount} layers ‚Ä¢ Scale: ${preset.defaultScale}%</div>
            </div>
            <div class="inline" style="margin-left:auto;gap:4px">
              <button class="btn" onclick="presetLibrary.editPreset('${preset.id}')" style="padding:4px 8px;font-size:11px">Edit</button>
              <button class="btn" onclick="presetLibrary.duplicatePreset('${preset.id}')" style="padding:4px 8px;font-size:11px">Duplicate</button>
            </div>
          `;

          // Click to edit
          item.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') {
              this.editPreset(preset.id);
            }
          });

          library.appendChild(item);
        });
      }

      filterPresets(searchTerm, category) {
        const items = document.querySelectorAll('#presetLibrary .asset-item');
        
        items.forEach(item => {
          const name = item.querySelector('.asset-name').textContent.toLowerCase();
          const meta = item.querySelector('.asset-meta').textContent.toLowerCase();
          
          const matchesSearch = !searchTerm || name.includes(searchTerm.toLowerCase()) || meta.includes(searchTerm.toLowerCase());
          const matchesCategory = !category || meta.includes(category.toLowerCase());
          
          item.style.display = (matchesSearch && matchesCategory) ? 'flex' : 'none';
        });
      }

      createNewPreset() {
        const newPreset = {
          id: `preset-${Date.now()}`,
          name: 'New Preset',
          category: 'Custom',
          defaultScale: 32,
          defaultStrength: 133,
          layers: []
        };

        this.presets.set(newPreset.id, newPreset);
        this.renderPresetLibrary();
        this.editPreset(newPreset.id);
      }

      editPreset(presetId) {
        const preset = this.presets.get(presetId);
        if (!preset) return;

        this.currentPreset = preset;
        this.loadPresetIntoEditor(preset);
        
        // Show editor
        document.getElementById('presetEditor').style.display = 'block';
        
        // Scroll to editor
        document.getElementById('presetEditor').scrollIntoView({ behavior: 'smooth' });
      }

      loadPresetIntoEditor(preset) {
        document.getElementById('presetId').value = preset.id;
        document.getElementById('presetName').value = preset.name;
        document.getElementById('category').value = preset.category;
        document.getElementById('defaultScale').value = preset.defaultScale;
        document.getElementById('defaultStrength').value = preset.defaultStrength;
        document.getElementById('premiumPreset').checked = preset.premium || false;

        // Load layers
        this.loadLayersIntoEditor(preset.layers || []);
      }

      loadLayersIntoEditor(layers) {
        const layerConfig = document.getElementById('layerConfig');
        layerConfig.innerHTML = '';

        layers.forEach((layer, index) => {
          this.addLayerToEditor(layer, index);
        });

        if (layers.length === 0) {
          this.addLayerToEditor({}, 0);
        }
      }

      addLayerToEditor(layer, index) {
        const layerConfig = document.getElementById('layerConfig');
        const layerDiv = document.createElement('div');
        layerDiv.className = 'layer';
        layerDiv.innerHTML = `
          <div class="inline" style="justify-content:space-between;margin-bottom:8px">
            <h4>Layer ${index + 1}</h4>
            <button class="btn" onclick="presetLibrary.removeLayer(${index})" style="padding:4px 8px">Remove</button>
          </div>
          <div class="row">
            <div class="col-12">
              <label>Resource</label>
              <input type="text" data-layer-src value="${layer.src || ''}" placeholder="resource://horizontal-bands">
            </div>
            <div class="col-4">
              <label>Tiling</label>
              <select data-layer-tiling>
                <option value="tiled" ${layer.tiling === 'tiled' ? 'selected' : ''}>Tiled</option>
                <option value="stretched" ${layer.tiling === 'stretched' ? 'selected' : ''}>Stretched</option>
              </select>
            </div>
            <div class="col-4">
              <label>Scale Mode</label>
              <select data-layer-scaleMode>
                <option value="uniform" ${layer.scaleMode === 'uniform' ? 'selected' : ''}>Uniform</option>
                <option value="xOnly" ${layer.scaleMode === 'xOnly' ? 'selected' : ''}>X Only</option>
                <option value="yOnly" ${layer.scaleMode === 'yOnly' ? 'selected' : ''}>Y Only</option>
              </select>
            </div>
            <div class="col-4">
              <label>Blend Mode</label>
              <select data-layer-blendMode>
                <option value="" ${!layer.blendMode ? 'selected' : ''}>Normal</option>
                <option value="multiply" ${layer.blendMode === 'multiply' ? 'selected' : ''}>Multiply</option>
                <option value="overlay" ${layer.blendMode === 'overlay' ? 'selected' : ''}>Overlay</option>
                <option value="screen" ${layer.blendMode === 'screen' ? 'selected' : ''}>Screen</option>
              </select>
            </div>
          </div>
        `;
        layerConfig.appendChild(layerDiv);
      }

      removeLayer(index) {
        const layers = document.querySelectorAll('#layerConfig .layer');
        if (layers[index]) {
          layers[index].remove();
          this.renumberLayers();
        }
      }

      renumberLayers() {
        const layers = document.querySelectorAll('#layerConfig .layer');
        layers.forEach((layer, index) => {
          const title = layer.querySelector('h4');
          if (title) title.textContent = `Layer ${index + 1}`;
        });
      }

      duplicatePreset(presetId) {
        const preset = this.presets.get(presetId);
        if (!preset) return;

        const duplicate = {
          ...preset,
          id: `${preset.id}-copy-${Date.now()}`,
          name: `${preset.name} (Copy)`,
          layers: preset.layers ? [...preset.layers] : []
        };

        this.presets.set(duplicate.id, duplicate);
        this.renderPresetLibrary();
      }

      saveCurrentPreset() {
        if (!this.currentPreset) return;

        // Collect data from editor
        const updatedPreset = {
          ...this.currentPreset,
          id: document.getElementById('presetId').value,
          name: document.getElementById('presetName').value,
          category: document.getElementById('category').value,
          defaultScale: parseInt(document.getElementById('defaultScale').value),
          defaultStrength: parseInt(document.getElementById('defaultStrength').value),
          premium: document.getElementById('premiumPreset').checked,
          layers: this.collectLayersFromEditor(),
          order: this.currentPreset.order || this.getNextOrderNumber()
        };

        // Update in memory
        this.presets.set(updatedPreset.id, updatedPreset);
        this.currentPreset = updatedPreset;

        // Re-render library
        this.renderPresetLibrary();

        // Generate complete presets.json file
        this.generatePresetsJson();

        console.log('Preset saved:', updatedPreset);
      }

      getNextOrderNumber() {
        let maxOrder = 0;
        this.presets.forEach(preset => {
          if (preset.order && preset.order > maxOrder) {
            maxOrder = preset.order;
          }
        });
        return maxOrder + 1;
      }

      generatePresetsJson() {
        const presetsArray = Array.from(this.presets.values());
        
        const manifest = {
          version: '1.0.0',
          updated: new Date().toISOString(),
          presets: presetsArray.sort((a, b) => {
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø–æ—Ç–æ–º –ø–æ order, –ø–æ—Ç–æ–º –ø–æ –∏–º–µ–Ω–∏
            const categoryOrder = {
              'Popular': 1, 'Ribbed glass': 2, 'Fabric': 3, 
              'Geometric': 4, 'Organic': 5, 'Custom': 100
            };
            
            const pa = categoryOrder[a.category] || 999;
            const pb = categoryOrder[b.category] || 999;
            if (pa !== pb) return pa - pb;
            
            const oa = a.order || 9999;
            const ob = b.order || 9999;
            if (oa !== ob) return oa - ob;
            
            return a.name.localeCompare(b.name);
          })
        };

        const output = JSON.stringify(manifest, null, 2);
        document.getElementById('output').textContent = output;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é
        this.showSaveInstructions();
      }

      showSaveInstructions() {
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.innerHTML = `
          <div class="status success">
            ‚úÖ presets.json –≥–æ—Ç–æ–≤!<br>
            <strong>–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:</strong><br>
            1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ JSON –∏–∑ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏<br>
            2. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ assets/presets.json<br>
            3. Git commit & push ‚Üí –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π –Ω–∞ CDN<br>
            4. –ü—Ä–µ—Å–µ—Ç—ã –æ–±–Ω–æ–≤—è—Ç—Å—è –≤ –ø–ª–∞–≥–∏–Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
          </div>
        `;
      }

      collectLayersFromEditor() {
        const layers = [];
        const layerDivs = document.querySelectorAll('#layerConfig .layer');
        
        layerDivs.forEach(div => {
          const src = div.querySelector('[data-layer-src]').value.trim();
          if (!src) return;

          const layer = {
            src,
            tiling: div.querySelector('[data-layer-tiling]').value,
            scaleMode: div.querySelector('[data-layer-scaleMode]').value
          };

          const blendMode = div.querySelector('[data-layer-blendMode]').value;
          if (blendMode) layer.blendMode = blendMode;

          layers.push(layer);
        });

        return layers;
      }

      generatePresetOutput(preset) {
        const output = `import type { Preset } from '../types';

const preset: Preset = ${JSON.stringify(preset, null, 2)};

export default preset;`;

        document.getElementById('output').textContent = output;
      }
    }

    class AssetManager {
      constructor() {
        this.assets = new Map();
        this.cdnUrl = 'https://dispace-figma-assets.vercel.app';
        this.manifestUrl = 'https://dispace-figma-assets.vercel.app/manifest.json';
        this.initEventListeners();
        this.loadExistingAssets();
      }

      initEventListeners() {
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        // Drag & Drop
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', () => {
          uploadZone.classList.remove('dragover');
        });
        uploadZone.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadZone.classList.remove('dragover');
          this.handleFiles(e.dataTransfer.files);
        });

        // File Input
        fileInput.addEventListener('change', (e) => {
          this.handleFiles(e.target.files);
        });

        // CDN Upload
        document.getElementById('uploadToCdn').addEventListener('click', () => {
          this.uploadToCdn();
        });

        document.getElementById('generateManifest').addEventListener('click', () => {
          this.generateManifest();
        });
      }

      async loadExistingAssets() {
        try {
          const response = await fetch(this.manifestUrl);
          if (response.ok) {
            const manifest = await response.json();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
            Object.entries(manifest.resources || {}).forEach(([category, resources]) => {
              Object.entries(resources).forEach(([id, resource]) => {
                this.assets.set(id, {
                  id,
                  name: `${id}.${resource.type}`,
                  type: resource.type,
                  size: resource.size || 0,
                  dataUrl: `${manifest.baseUrl}${resource.path}`,
                  dimensions: resource.dimensions || { width: 0, height: 0 },
                  hash: resource.hash,
                  isFromCDN: true
                });
              });
            });
            
            this.updateAssetLibrary();
            console.log(`Loaded ${this.assets.size} assets from CDN`);
          }
        } catch (error) {
          console.warn('Could not load existing assets from CDN:', error);
        }
      }

      async handleFiles(files) {
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.innerHTML = '';

        for (const file of files) {
          if (!this.validateFile(file)) continue;

          try {
            const asset = await this.processFile(file);
            this.assets.set(asset.id, asset);
            this.updateAssetLibrary();
            
            const status = document.createElement('div');
            status.className = 'status success';
            status.textContent = `‚úÖ ${file.name} processed successfully`;
            statusDiv.appendChild(status);
            
          } catch (error) {
            const status = document.createElement('div');
            status.className = 'status error';
            status.textContent = `‚ùå Failed to process ${file.name}: ${error.message}`;
            statusDiv.appendChild(status);
          }
        }
      }

      validateFile(file) {
        const maxSize = 2 * 1024 * 1024; // 2MB
        const allowedTypes = ['image/svg+xml', 'image/png'];
        
        if (!allowedTypes.includes(file.type)) {
          throw new Error('Only SVG and PNG files are supported');
        }
        
        if (file.size > maxSize) {
          throw new Error('File size must be less than 2MB');
        }
        
        return true;
      }

      async processFile(file) {
        const id = this.generateAssetId(file.name);
        const dataUrl = await this.fileToDataUrl(file);
        const dimensions = await this.getImageDimensions(dataUrl);
        
        return {
          id,
          name: file.name,
          type: file.type.includes('svg') ? 'svg' : 'png',
          size: file.size,
          dataUrl,
          dimensions,
          hash: await this.generateHash(dataUrl)
        };
      }

      generateAssetId(filename) {
        return filename
          .replace(/\.[^/.]+$/, '') // Remove extension
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '');
      }

      fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(reader.error);
          reader.readAsDataURL(file);
        });
      }

      getImageDimensions(dataUrl) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve({ width: img.width, height: img.height });
          img.src = dataUrl;
        });
      }

      async generateHash(data) {
        const encoder = new TextEncoder();
        const dataBuffer = encoder.encode(data);
        const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return 'sha256-' + hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      }

      updateAssetLibrary() {
        const library = document.getElementById('assetLibrary');
        library.innerHTML = '';

        if (this.assets.size === 0) {
          library.innerHTML = `
            <div class="asset-item">
              <div class="asset-preview">üé®</div>
              <div class="asset-info">
                <div class="asset-name">No assets uploaded</div>
                <div class="asset-meta">Upload some SVG/PNG files to get started</div>
              </div>
            </div>
          `;
          return;
        }

        this.assets.forEach((asset) => {
          const item = document.createElement('div');
          item.className = 'asset-item';
          const cdnBadge = asset.isFromCDN ? '<span style="background:#0f382b;color:#34d399;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:4px">CDN</span>' : '';
          
          item.innerHTML = `
            <div class="asset-preview">
              <img src="${asset.dataUrl}" alt="${asset.name}" style="max-width:100%;max-height:100%;object-fit:contain">
            </div>
            <div class="asset-info">
              <div class="asset-name">${asset.name}${cdnBadge}</div>
              <div class="asset-meta">${asset.type.toUpperCase()} ‚Ä¢ ${asset.dimensions.width}√ó${asset.dimensions.height} ‚Ä¢ ${Math.round(asset.size/1024)}KB</div>
            </div>
            <button class="btn" onclick="assetManager.useAsset('${asset.id}')" style="margin-left:auto">${asset.isFromCDN ? 'Use' : 'Upload & Use'}</button>
          `;
          library.appendChild(item);
        });
      }

      useAsset(assetId) {
        const asset = this.assets.get(assetId);
        if (!asset) return;

        // –î–ª—è CDN —Ä–µ—Å—É—Ä—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º resource:// URL
        const resourceUrl = asset.isFromCDN ? `resource://${assetId}` : asset.dataUrl;
        
        // Add to current preset layer
        this.addLayerWithAsset(asset, resourceUrl);
        
        // Update preview
        this.updatePreview(asset);
      }

      addLayerWithAsset(asset, resourceUrl) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –≤ —Ç–µ–∫—É—â–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –ø—Ä–µ—Å–µ—Ç
        if (presetLibrary.currentPreset) {
          const layerConfig = document.getElementById('layerConfig');
          const layerCount = layerConfig.children.length;
          const layer = presetLibrary.addLayerToEditor({ 
            src: resourceUrl,
            tiling: 'tiled', 
            scaleMode: 'uniform' 
          }, layerCount);
          
          // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ src
          const srcInput = layer.querySelector('[data-layer-src]');
          if (srcInput) srcInput.value = resourceUrl;
          
          console.log(`Added layer with ${asset.isFromCDN ? 'CDN' : 'local'} asset:`, resourceUrl);
        } else {
          alert('Please create or select a preset first');
        }
      }



      updatePreview(asset) {
        const previewMap = document.getElementById('previewMap');
        if (previewMap) {
          previewMap.setAttribute('href', asset.dataUrl);
        }
      }

      async uploadToCdn() {
        const cdnUrl = document.getElementById('cdnUrl').value;
        if (!cdnUrl) {
          alert('Please enter CDN URL');
          return;
        }

        // This would integrate with your CDN upload service
        console.log('Uploading to CDN:', cdnUrl);
        alert('CDN upload would happen here - integrate with your Vercel/GitHub workflow');
      }

      generateManifest() {
        const manifest = {
          version: '1.0.0',
          baseUrl: document.getElementById('cdnUrl').value,
          resources: {
            'displacement-maps': {}
          }
        };

        this.assets.forEach((asset, id) => {
          manifest.resources['displacement-maps'][id] = {
            type: asset.type,
            path: `/displacement-maps/${asset.type}/${id}.${asset.type}`,
            hash: asset.hash,
            size: asset.size,
            dimensions: asset.dimensions
          };
        });

        document.getElementById('output').textContent = JSON.stringify(manifest, null, 2);
      }
    }

    // Initialize
    const presetLibrary = new PresetLibraryManager();
    const assetManager = new AssetManager();

    // Add layer button
    document.getElementById('addLayer').addEventListener('click', () => {
      const layerConfig = document.getElementById('layerConfig');
      const layerCount = layerConfig.children.length;
      presetLibrary.addLayerToEditor({}, layerCount);
    });

    // Save preset button
    document.getElementById('saveFile').addEventListener('click', () => {
      presetLibrary.saveCurrentPreset();
    });

    // Copy output
    document.getElementById('copyOutput').addEventListener('click', () => {
      const output = document.getElementById('output').textContent;
      navigator.clipboard.writeText(output).then(() => {
        alert('Copied to clipboard!');
      });
    });
  </script>
</body>
</html>
