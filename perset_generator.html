<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preset Builder — SVG/PNG layers → Preset JSON/TS</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151821; --muted:#8a92a6; --text:#e8ecf3; --primary:#6ee7ff;
      --accent:#a78bfa; --ok:#34d399; --warn:#f59e0b; --danger:#ef4444; --border:#222738;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0e1117,#0b0d13 40%,#0e1117);color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1{font-size:20px;margin:0 0 8px 0}
    h2{font-size:16px;margin:16px 0 8px 0}
    .app{max-width:1060px;margin:24px auto;padding:0 16px}
    .grid{display:grid;gap:12px}
    .cols{grid-template-columns:1.1fr 1fr}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;
      box-shadow:0 6px 20px rgba(0,0,0,.25)}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%;padding:9px 10px;border-radius:10px;border:1px solid var(--border);
      background:#0c0f16;color:var(--text);outline:none;transition:.2s border-color,.2s box-shadow;
    }
    input[type="number"]{appearance:textfield}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .row > .col-3{grid-column:span 3}
    .row > .col-4{grid-column:span 4}
    .row > .col-6{grid-column:span 6}
    .row > .col-8{grid-column:span 8}
    .row > .col-12{grid-column:span 12}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:9px 12px;border-radius:10px;
      border:1px solid var(--border);color:var(--text);background:#10131b;cursor:pointer;
      transition:.15s transform,.2s background,.2s border-color;user-select:none}
    .btn:hover{background:#141827}
    .btn.primary{background:linear-gradient(180deg,#1a2a3a,#122233);border-color:#1e293b}
    .btn.primary:hover{filter:brightness(1.12)}
    .btn.ok{background:linear-gradient(180deg,#0f382b,#0d2f24);border-color:#134e4a}
    .btn.warn{background:linear-gradient(180deg,#402f15,#2c2213);border-color:#3f2d16}
    .btn.ghost{background:transparent}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);
      font-size:11px;color:var(--muted)}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .layer{background:#0f1420;border:1px dashed #27304a;border-radius:12px;padding:12px;margin-top:10px}
    .layer h3{margin:0 0 8px 0;font-size:14px}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .inline > *{flex:0 0 auto}
    .sep{height:1px;background:var(--border);margin:12px 0}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;background:#0b0e14;border:1px solid var(--border);
      border-radius:12px;padding:12px;min-height:160px}
    .tip{border-left:3px solid var(--accent);padding:10px 12px;background:#121629;border-radius:10px}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{accent-color:var(--accent)}
    .sr{position:absolute;clip:rect(0 0 0 0);clip-path:inset(50%);height:1px;width:1px;overflow:hidden;white-space:nowrap}
    .footer{opacity:.7;margin-top:16px}
  </style>
</head>
<body>
  <div class="app">
    <h1>Preset Builder <span class="badge">Draft</span></h1>
    <p class="muted small">Собирай пресет по твоей схеме: Preset → layers[] → экспорт JSON/TS. Есть помощник кодирования SVG → data URI.</p>

    <div class="grid cols">
      <!-- LEFT: FORM -->
      <div class="card">
        <h2>1) Общие настройки пресета</h2>
        <label class="switch" style="margin-top:4px;display:inline-flex;gap:6px"><input id="simpleMode" type="checkbox" checked /> Упрощённый интерфейс</label>
        <div class="row">
          <div class="col-6">
            <label for="id">id</label>
            <input id="id" type="text" placeholder="svg-bands-1" />
          </div>
          <div class="col-6">
            <label for="name">name</label>
            <input id="name" type="text" placeholder="SVG Bands" />
          </div>
          <div class="col-6">
            <label for="category">category</label>
            <input id="category" type="text" placeholder="SVG" />
          </div>
          <div class="col-3">
            <label for="defaultScale">defaultScale (%)</label>
            <input id="defaultScale" type="number" min="2" max="60" step="1" value="20" />
          </div>
          <div class="col-3">
            <label for="defaultStrength">defaultStrength (0..200)</label>
            <input id="defaultStrength" type="number" min="0" max="200" step="1" value="50" />
          </div>
          <div class="col-6 inline">
            <label class="switch"><input id="premium" type="checkbox" /> premium</label>
            <label class="switch"><input id="isCustom" type="checkbox" /> isCustom</label>
            <label class="switch"><input id="createdAt" type="checkbox" checked /> createdAt (timestamp)</label>
          </div>
        </div>

        <div class="sep"></div>
        <h2>2) Слои <span class="muted small">(верх рисуется поверх нижнего)</span></h2>
        <div id="layers"></div>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn" id="addLayerBtn">+ Добавить слой</button>
          <span class="muted small">Подсказка: оставляй <code>scale</code> пустым, чтобы работал глобальный слайдер.</span>
        </div>

        <div class="sep"></div>
        <h2>3) SVG → data URI (вспомогательно)</h2>
        <div class="row">
          <div class="col-12">
            <label for="svgInput">Вставь SVG</label>
            <textarea id="svgInput" placeholder="<svg>…"></textarea>
          </div>
          <div class="col-12 inline">
            <button class="btn" id="encodeBtn">Преобразовать в data URI</button>
            <span class="muted small">Результат вставится в текущее поле <b>src</b> активного слоя.</span>
          </div>
        </div>
      </div>

      <!-- RIGHT: OUTPUT -->
      <div class="card">
        <h2>Экспорт</h2>
        <div class="inline" style="margin-bottom:8px">
          <label>Формат:</label>
          <select id="format">
            <option value="tsfile">TypeScript file (.ts)</option>
            <option value="object">Object snippet (JS/TS)</option>
            <option value="json">JSON</option>
          </select>
          <label class="small" style="margin-left:8px">import path</label>
          <input id="importPath" type="text" value="../types" style="max-width:180px" />
          <label class="switch"><input id="minify" type="checkbox" /> minify</label>
        </div>
        <pre id="output" aria-live="polite"></pre>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn ok" id="saveBtn">Сохранить .ts</button>
          <button class="btn primary" id="copyBtn">Скопировать</button>
          <button class="btn ghost" id="regenBtn">Перегенерировать</button>
          <button class="btn warn" id="resetBtn">Сброс</button>
          <label class="switch"><input id="saveOnCopy" type="checkbox" checked /> автосохранение .ts при копировании</label>
        </div>
        <div class="tip" style="margin-top:12px">
          <div class="small">ℹ️  Правила:
            <ul>
              <li>Если <b>tiling = 'stretched'</b> → <code>scale</code>, <code>scaleMode</code>, <code>alignX/alignY</code> игнорируются.</li>
              <li>Если <b>tiling = 'tiled'</b> → работает <code>scale</code> (или глобальный <code>defaultScale</code>), <code>scaleMode</code>, <code>alignX/alignY</code>.</li>
              <li>Заполняй только нужные поля — пустые опциональные не попадут в экспорт.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <p class="footer small muted">Made for Mike · schema: Preset / PresetLayer (universal). Без зависимостей.</p>
  </div>

  <!-- LIVE PREVIEW (minimal) -->
  <div class="app" style="margin-top:0">
    <div class="card">
      <h2>Live Preview</h2>
      <div id="livePreview" style="width:100%;height:360px;position:relative;background:#0b0e14;border-radius:12px;overflow:hidden">
        <svg id="liveSvg" viewBox="0 0 800 600" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <filter id="dispFilter" x="-20%" y="-20%" width="140%" height="140%">
              <feImage id="dispMapImage" href="" result="map"/>
              <feDisplacementMap id="dispNode" in="SourceGraphic" in2="map" scale="50" xChannelSelector="R" yChannelSelector="G"/>
            </filter>
          </defs>
          <image id="liveSource" x="0" y="0" width="800" height="600" preserveAspectRatio="xMidYMid slice" filter="url(#dispFilter)" href="sample01.png"/>
        </svg>
      </div>
      <div class="inline" style="margin-top:8px;align-items:center">
        <label class="small" style="min-width:70px">Strength</label>
        <input id="lvStrength" type="range" min="0" max="200" step="1" style="flex:1" />
        <label class="small" style="min-width:70px;margin-left:12px">Scale</label>
        <input id="lvScale" type="range" min="2" max="60" step="1" style="flex:1" />
      </div>
      <div class="small muted" style="margin-top:6px">Используются <b>defaultStrength</b> и <b>defaultScale</b>. Исходное изображение: <code>sample01.png</code> (рядом с HTML).</div>
    </div>
  </div>

  <template id="layerTemplate">
    <div class="layer" data-layer>
      <div class="inline" style="justify-content:space-between">
        <h3>Слой <span class="badge" data-title>1</span></h3>
        <div class="inline">
          <button class="btn ghost" data-dup title="Дублировать слой">Дублировать</button>
          <button class="btn ghost" data-up title="Выше">↑</button>
          <button class="btn ghost" data-down title="Ниже">↓</button>
          <button class="btn" data-remove title="Удалить слой">Удалить</button>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <label>src <span class="muted small">(URL или data URI)</span></label>
          <textarea data-src placeholder="https://… или data:image/svg+xml,…"></textarea>
        </div>
        <div class="col-4">
          <label>tiling</label>
          <select data-tiling>
            <option value="tiled">tiled</option>
            <option value="stretched">stretched</option>
          </select>
        </div>
        <div class="col-4">
          <label>scale (%) <span class="muted small">(опц.)</span></label>
          <input type="number" data-scale min="2" max="400" step="1" placeholder="—" />
        </div>
        <div class="col-4">
          <label>scaleMode</label>
          <select data-scaleMode>
            <option value="uniform">uniform</option>
            <option value="xOnly">xOnly</option>
            <option value="yOnly">yOnly</option>
          </select>
        </div>
        <div class="col-4" data-adv>
          <label>opacity 0..1</label>
          <input type="number" data-opacity min="0" max="1" step="0.05" placeholder="1" />
        </div>
        <div class="col-4" data-adv>
          <label>blendMode</label>
          <select data-blendMode>
            <option value="">(по умолчанию)</option>
            <option>source-over</option>
            <option>multiply</option>
            <option>screen</option>
            <option>overlay</option>
            <option>darken</option>
            <option>lighten</option>
            <option>color-dodge</option>
            <option>color-burn</option>
            <option>hard-light</option>
            <option>soft-light</option>
            <option>difference</option>
            <option>exclusion</option>
            <option>hue</option>
            <option>saturation</option>
            <option>color</option>
            <option>luminosity</option>
          </select>
        </div>
        <div class="col-4">
          <label>alignX (tiled)</label>
          <select data-alignX>
            <option value="">(default left)</option>
            <option>left</option>
            <option>center</option>
            <option>right</option>
          </select>
        </div>
        <div class="col-4">
          <label>alignY (tiled)</label>
          <select data-alignY>
            <option value="">(default top)</option>
            <option>top</option>
            <option>center</option>
            <option>bottom</option>
          </select>
        </div>
        <div class="col-4" data-adv>
          <label>offsetX (px)</label>
          <input type="number" data-offsetX step="1" placeholder="0" />
        </div>
        <div class="col-4" data-adv>
          <label>offsetY (px)</label>
          <input type="number" data-offsetY step="1" placeholder="0" />
        </div>
      </div>
    </div>
  </template>

  <script>
  const els = {
    id: document.getElementById('id'),
    name: document.getElementById('name'),
    category: document.getElementById('category'),
    defaultScale: document.getElementById('defaultScale'),
    defaultStrength: document.getElementById('defaultStrength'),
    premium: document.getElementById('premium'),
    isCustom: document.getElementById('isCustom'),
    createdAt: document.getElementById('createdAt'),
    simpleMode: document.getElementById('simpleMode'),
    layers: document.getElementById('layers'),
    addLayerBtn: document.getElementById('addLayerBtn'),
    svgInput: document.getElementById('svgInput'),
    encodeBtn: document.getElementById('encodeBtn'),
    output: document.getElementById('output'),
    format: document.getElementById('format'),
    minify: document.getElementById('minify'),
    copyBtn: document.getElementById('copyBtn'),
    saveBtn: document.getElementById('saveBtn'),
    saveOnCopy: document.getElementById('saveOnCopy'),
    importPath: document.getElementById('importPath'),
    regenBtn: document.getElementById('regenBtn'),
    resetBtn: document.getElementById('resetBtn'),
  };

  let activeLayer = null; // где вставлять data URI после кодирования

  const LAYER_FIELDS = ['src','tiling','scale','scaleMode','opacity','blendMode','alignX','alignY','offsetX','offsetY'];

  function newLayer(initial={}){
    const tpl = document.getElementById('layerTemplate');
    const node = tpl.content.firstElementChild.cloneNode(true);

    const refs = {
      root: node,
      title: node.querySelector('[data-title]'),
      src: node.querySelector('[data-src]'),
      tiling: node.querySelector('[data-tiling]'),
      scale: node.querySelector('[data-scale]'),
      scaleMode: node.querySelector('[data-scaleMode]'),
      opacity: node.querySelector('[data-opacity]'),
      blendMode: node.querySelector('[data-blendMode]'),
      alignX: node.querySelector('[data-alignX]'),
      alignY: node.querySelector('[data-alignY]'),
      offsetX: node.querySelector('[data-offsetX]'),
      offsetY: node.querySelector('[data-offsetY]'),
      btnRemove: node.querySelector('[data-remove]'),
      btnDup: node.querySelector('[data-dup]'),
      btnUp: node.querySelector('[data-up]'),
      btnDown: node.querySelector('[data-down]'),
    };

    // init values
    Object.entries(initial).forEach(([k,v])=>{
      if(refs[k]!==undefined && refs[k]!=null){
        if(refs[k] instanceof HTMLInputElement || refs[k] instanceof HTMLTextAreaElement){
          refs[k].value = v;
        }else if(refs[k] instanceof HTMLSelectElement){
          refs[k].value = v;
        }
      }
    });

    // focus tracking for SVG encoder target
    refs.src.addEventListener('focus',()=>{ activeLayer = refs; });
    refs.src.addEventListener('click',()=>{ activeLayer = refs; });

    // toggle fields depending on tiling
    function syncTilingFields(){
      const isStretched = refs.tiling.value === 'stretched';
      [refs.scale, refs.scaleMode, refs.alignX, refs.alignY].forEach(ctrl=>{
        ctrl.disabled = isStretched; // по схеме эти поля игнорируются
      });
    }
    refs.tiling.addEventListener('change', syncTilingFields);
    syncTilingFields();

    // actions
    refs.btnRemove.addEventListener('click',()=>{ node.remove(); renumberLayers(); render(); });
    refs.btnDup.addEventListener('click',()=>{
      const data = readLayer(refs);
      const clone = newLayer(data);
      node.after(clone.root);
      renumberLayers();
      render();
    });
    refs.btnUp.addEventListener('click',()=>{
      const prev = node.previousElementSibling; if(prev) prev.before(node); renumberLayers(); render();
    });
    refs.btnDown.addEventListener('click',()=>{
      const next = node.nextElementSibling; if(next) next.after(node); renumberLayers(); render();
    });

    // re-render on change
    node.addEventListener('input', render);

    return refs;
  }

  function renumberLayers(){
    [...els.layers.querySelectorAll('[data-layer]')].forEach((el,idx)=>{
      const b = el.querySelector('[data-title]');
      if(b) b.textContent = String(idx+1);
    });
  }

  function readLayer(refs){
    const obj = {};
    const src = refs.src.value.trim(); if(src) obj.src = src;
    const tiling = refs.tiling.value || 'tiled'; obj.tiling = tiling;
    const scale = refs.scale.value.trim(); if(scale) obj.scale = Number(scale);
    const scaleMode = refs.scaleMode.value || 'uniform'; if(tiling==='tiled' && scaleMode) obj.scaleMode = scaleMode;
    const opacity = refs.opacity.value.trim(); if(opacity) obj.opacity = Number(opacity);
    const blendMode = refs.blendMode.value.trim(); if(blendMode) obj.blendMode = blendMode;
    const alignX = refs.alignX.value.trim(); if(tiling==='tiled' && alignX) obj.alignX = alignX;
    const alignY = refs.alignY.value.trim(); if(tiling==='tiled' && alignY) obj.alignY = alignY;
    const offsetX = refs.offsetX.value.trim(); if(offsetX) obj.offsetX = Number(offsetX);
    const offsetY = refs.offsetY.value.trim(); if(offsetY) obj.offsetY = Number(offsetY);
    return obj;
  }

  function readPreset(){
    const p = {
      id: els.id.value.trim() || 'preset-id',
      name: els.name.value.trim() || 'Preset Name',
      layers: [],
      defaultScale: clampNum(Number(els.defaultScale.value), 2, 400) || 20,
      defaultStrength: clampNum(Number(els.defaultStrength.value), 0, 200) || 50,
      category: els.category.value.trim() || 'SVG',
    };
    if(els.premium.checked) p.premium = true;
    if(els.isCustom.checked) p.isCustom = true;
    if(els.createdAt.checked) p.createdAt = Date.now();

    const layerNodes = [...els.layers.querySelectorAll('[data-layer]')];
    p.layers = layerNodes.map(el=>{
      const refs = bindFromNode(el);
      return readLayer(refs);
    }).filter(l=>l.src && l.tiling);

    return p;
  }

  function bindFromNode(node){
    return {
      root: node,
      title: node.querySelector('[data-title]'),
      src: node.querySelector('[data-src]'),
      tiling: node.querySelector('[data-tiling]'),
      scale: node.querySelector('[data-scale]'),
      scaleMode: node.querySelector('[data-scaleMode]'),
      opacity: node.querySelector('[data-opacity]'),
      blendMode: node.querySelector('[data-blendMode]'),
      alignX: node.querySelector('[data-alignX]'),
      alignY: node.querySelector('[data-alignY]'),
      offsetX: node.querySelector('[data-offsetX]'),
      offsetY: node.querySelector('[data-offsetY]'),
    };
  }

  function clampNum(n, a, b){
    if(Number.isNaN(n)) return n; return Math.max(a, Math.min(b, n));
  }

  function toJson(preset, pretty=true){
    return JSON.stringify(preset, null, pretty?2:0);
  }

  function qs(str){
    return `'${String(str).replace(/'/g, "\\'")}'`;
  }
  function emitFields(obj, order, ind, nl){
    const lines=[]; const keys=[];
    for(const k of order){
      if(obj[k]===undefined || obj[k]===null || obj[k]==='') continue;
      keys.push(k);
    }
    keys.forEach((k, i)=>{
      const v = obj[k];
      const val = typeof v === 'string' ? qs(v) : v;
      lines.push(`${ind}${k}: ${val}${i<keys.length-1?',':''}${nl}`);
    });
    return lines.join('');
  }
  function normalizePreset(preset){
    const p = JSON.parse(JSON.stringify(preset));
    p.layers = (p.layers||[]).map(l=>{
      const layer = { ...l };
      if(typeof layer.src==='string'){
        const s = layer.src.trim();
        if(s.startsWith('<')) layer.src = svgToDataUri(s);
        else if(s.startsWith('data:image/svg+xml;utf8,'))
          layer.src = 'data:image/svg+xml,' + s.slice('data:image/svg+xml;utf8,'.length);
      }
      return layer;
    });
    return p;
  }
  function toObjectSnippet(preset, pretty=true){
    const p = normalizePreset(preset);
    const ind1 = pretty ? '  ' : '';
    const ind2 = pretty ? '    ' : '';
    const ind3 = pretty ? '      ' : '';
    const nl = pretty ? '\n' : '';
    const LAYER_ORDER = ['src','tiling','scale','scaleMode','opacity','blendMode','alignX','alignY','offsetX','offsetY'];
    const TOP_ORDER = ['id','name','category','defaultScale','defaultStrength','premium','isCustom','createdAt'];

    let out = '{'+nl;
    const topStrRaw = emitFields(p, TOP_ORDER, ind1, nl);
    if (topStrRaw) {
      if (pretty) {
        // remove last nl then add trailing comma and nl
        out += topStrRaw.replace(new RegExp(`${nl}$`), '') + ',' + nl;
      } else {
        out += topStrRaw + ',';
      }
    }
    out += `${ind1}layers: [`+nl;
    p.layers.forEach((layer, i)=>{
      out += ind2+'{'+nl;
      out += emitFields(layer, LAYER_ORDER, ind3, nl);
      out += ind2+'}'+(i<p.layers.length-1?',':'')+nl;
    });
    out += ind1+']'+nl;
    out += '}';
    return out;
  }
  function toTsFile(preset, pretty=true){
    const p = normalizePreset(preset);
    const obj = toObjectSnippet(p, pretty);
    const nl = pretty ? '\n' : '';
    const importPath = els.importPath?.value?.trim() || '../types';
    return `import type { Preset } from ${qs(importPath)};${nl}${nl}const preset: Preset = ${obj};${nl}${nl}export default preset;`;
  };

  function render(){
    const preset = readPreset();
    const fmt = els.format.value;
    const min = els.minify.checked;
    let out = '';
    if(fmt==='json') out = toJson(preset, !min);
    else if(fmt==='tsfile') out = toTsFile(preset, !min);
    else out = toObjectSnippet(preset, !min);
    els.output.textContent = out;
    // Update live preview
    updateLivePreview(preset);
    syncPreviewControls();
  }

  function copy(){
    const txt = els.output.textContent;
    navigator.clipboard.writeText(txt)
      .then(()=>{
        flash(els.copyBtn, 'Скопировано ✓');
        if(els.format.value==='tsfile' && els.saveOnCopy.checked){ saveCurrentTs(); }
      })
      .catch(()=>{
        flash(els.copyBtn, 'Не удалось скопировать', true);
      });
  }

  function flash(btn, msg, err){
    const orig = btn.textContent; btn.textContent = msg; btn.classList.toggle('ok', !err);
    setTimeout(()=>{ btn.textContent = orig; btn.classList.remove('ok'); }, 1200);
  }

  function resetForm(){
    els.id.value = ''; els.name.value = ''; els.category.value = 'SVG';
    els.defaultScale.value = 20; els.defaultStrength.value = 50;
    els.premium.checked = false; els.isCustom.checked = false; els.createdAt.checked = true;
    els.importPath.value = '../types';
    els.layers.innerHTML = '';
    addLayer({ tiling:'tiled', scaleMode:'uniform', alignX:'center', alignY:'center' });
    render();
    syncSimpleMode();
  }

  function addLayer(initial){
    const layer = newLayer(initial);
    els.layers.appendChild(layer.root);
    renumberLayers();
    activeLayer = layer;
    applySimpleModeToNode(layer.root);
    return layer;
  }

  function encodeSvg(){
    const svg = els.svgInput.value.trim();
    if(!svg){ alert('Вставь SVG'); return; }
    const uri = svgToDataUri(svg);
    if(!activeLayer){
      // если нет активного, создадим слой
      const layer = addLayer({tiling:'tiled', scaleMode:'uniform'});
      layer.src.value = uri;
      render();
      return;
    }
    activeLayer.src.value = uri;
    render();
  }

  function svgToDataUri(svg){
    const cleaned = svg
      .replace(/^\uFEFF/, '')
      .replace(/\r|\n|\t/g, '')
      .replace(/>\s+</g, '><')
      .trim();
    const encoded = encodeURIComponent(cleaned);
    return `data:image/svg+xml,${encoded}`;
  }

  // init
  els.addLayerBtn.addEventListener('click', ()=>{ addLayer({ tiling:'tiled', scaleMode:'uniform', alignX:'center', alignY:'center' }); render(); });
  els.encodeBtn.addEventListener('click', encodeSvg);
  els.copyBtn.addEventListener('click', copy);
  els.regenBtn.addEventListener('click', render);
  els.resetBtn.addEventListener('click', resetForm);
  document.querySelectorAll('input,select,textarea').forEach(el=> el.addEventListener('input', render));
  els.saveBtn.addEventListener('click', saveCurrentTs);
  els.simpleMode.addEventListener('change', syncSimpleMode);

  // start with one empty layer
  resetForm();
  function slugify(s){
    return String(s||'preset').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') || 'preset';
  }
  function downloadFile(name, content, mime='text/plain'){
    const blob = new Blob([content], {type: mime+';charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 0);
  }
  function saveCurrentTs(){
    const preset = readPreset();
    const code = toTsFile(preset, true);
    const base = slugify(preset.id || 'preset');
    downloadFile(`${base}.ts`, code, 'text/typescript');
    if(els.saveBtn) flash(els.saveBtn, 'Сохранено ✓');
  }
  function syncSimpleMode(){
    const on = !!els.simpleMode?.checked;
    document.querySelectorAll('[data-adv]').forEach(n=>{ n.style.display = on ? 'none' : ''; });
  }
  function applySimpleModeToNode(root){
    const on = !!els.simpleMode?.checked;
    root.querySelectorAll('[data-adv]').forEach(n=>{ n.style.display = on ? 'none' : ''; });
  }

  // ===== Live Preview (minimal engine reuse) =====
  const PREVIEW_W = 800;
  const PREVIEW_H = 600;
  const liveSvg = document.getElementById('liveSvg');
  const dispMapImage = document.getElementById('dispMapImage');
  const dispNode = document.getElementById('dispNode');
  const lvStrength = document.getElementById('lvStrength');
  const lvScale = document.getElementById('lvScale');

  function loadImage(src){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = ()=>resolve(img);
      img.onerror = ()=>reject(new Error('Failed to load '+src));
      img.src = src;
    });
  }

  function drawTiledMap(ctx, canvasW, canvasH, image, mapScale, scaleMode='uniform', alignX='left', alignY='top', offsetX=0, offsetY=0){
    let w = Math.max(1, image.width * mapScale);
    let h = Math.max(1, image.height * mapScale);
    const mode = scaleMode || 'uniform';
    if(mode==='xOnly') h = Math.max(1, canvasH);
    else if(mode==='yOnly') w = Math.max(1, canvasW);

    let originX = 0, originY = 0;
    if(alignX==='center') originX = Math.floor((canvasW - w) / 2);
    else if(alignX==='right') originX = canvasW - w;
    if(alignY==='center') originY = Math.floor((canvasH - h) / 2);
    else if(alignY==='bottom') originY = canvasH - h;
    originX += offsetX; originY += offsetY;

    const startI = Math.floor((0 - originX) / w) - 1;
    const startJ = Math.floor((0 - originY) / h) - 1;
    const endI = Math.ceil((canvasW - originX) / w) + 1;
    const endJ = Math.ceil((canvasH - originY) / h) + 1;
    for(let i=startI;i<=endI;i++){
      for(let j=startJ;j<=endJ;j++){
        const x = originX + i*w;
        const y = originY + j*h;
        if (x > canvasW || y > canvasH) continue;
        if (x + w < 0 || y + h < 0) continue;
        ctx.drawImage(image, x, y, w, h);
      }
    }
  }

  function drawLayer(ctx, canvasW, canvasH, image, tiling, scalePct, scaleMode, opacity=1, blendMode='source-over', alignX='left', alignY='top', offsetX=0, offsetY=0, baseScale=1){
    ctx.save();
    ctx.globalAlpha = Math.max(0, Math.min(1, opacity));
    ctx.globalCompositeOperation = blendMode || 'source-over';
    if(tiling==='tiled'){
      const mapScale = (scalePct * 0.01) * baseScale;
      drawTiledMap(ctx, canvasW, canvasH, image, mapScale, scaleMode, alignX, alignY, offsetX, offsetY);
    }else{
      if (offsetX!==0 || offsetY!==0) ctx.translate(offsetX, offsetY);
      ctx.drawImage(image, 0, 0, canvasW, canvasH);
    }
    ctx.restore();
  }

  async function updateLivePreview(preset){
    try{
      if(!preset){ preset = readPreset(); }
      const canvas = document.createElement('canvas');
      canvas.width = PREVIEW_W; canvas.height = PREVIEW_H;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,PREVIEW_W,PREVIEW_H);

      // Load valid layer images (skip empty src) resiliently
      const layersAll = Array.isArray(preset.layers) ? preset.layers : [];
      const layers = layersAll.filter(l => l && typeof l.src === 'string' && l.src.trim());
      const images = await Promise.all(layers.map(l => loadImage(l.src).catch(()=>null)));

      // Base scale ratio similar to engine: max(image)/max(map)
      const refImg = images.find(Boolean);
      const cachedImageMax = Math.max(PREVIEW_W, PREVIEW_H);
      const cachedMapMax = refImg ? Math.max(refImg.width, refImg.height) : 1;
      const baseScale = cachedMapMax ? (cachedImageMax / cachedMapMax) : 1;

      // Draw layers
      layers.forEach((layer, i)=>{
        const img = images[i];
        if(!img) return;
        const scalePct = (typeof layer.scale === 'number') ? layer.scale : preset.defaultScale;
        drawLayer(
          ctx,
          PREVIEW_W,
          PREVIEW_H,
          img,
          layer.tiling,
          scalePct,
          layer.scaleMode || 'uniform',
          typeof layer.opacity==='number' ? layer.opacity : 1,
          layer.blendMode || 'source-over',
          layer.alignX || 'left',
          layer.alignY || 'top',
          layer.offsetX || 0,
          layer.offsetY || 0,
          baseScale
        );
      });

      // If no layers drew anything, fill neutral gray to avoid undefined map
      if (!layers.length) {
        ctx.fillStyle = '#808080';
        ctx.fillRect(0,0,PREVIEW_W,PREVIEW_H);
      }

      // Apply to SVG filter
      if(dispMapImage){
        try{ dispMapImage.setAttribute('href', canvas.toDataURL('image/png')); }catch{}
      }
      if(dispNode){
        const s = Number(preset.defaultStrength)||0; // 0..200 typical
        dispNode.setAttribute('scale', String(s));
      }
    }catch(err){
      // silent fail in preview
      console.warn('Live preview failed:', err);
    }
  }

  // Bind minimal controls to defaultStrength/defaultScale
  function syncPreviewControls(){
    if(lvStrength) lvStrength.value = String(els.defaultStrength.value || 0);
    if(lvScale) lvScale.value = String(els.defaultScale.value || 20);
  }
  if(lvStrength){
    lvStrength.addEventListener('input', ()=>{
      els.defaultStrength.value = lvStrength.value;
      render();
    });
  }
  if(lvScale){
    lvScale.addEventListener('input', ()=>{
      els.defaultScale.value = lvScale.value;
      render();
    });
  }
  </script>
</body>
</html>
